image: docker:dind

variables:
  PROJECT: 'agents-mulesoft'
  CSR_SUPPRESSION_LIST: "/tmp/csr-suppressions/amplify-central/golang-agents-common.json"

  # Fortify
  FORTIFY_PROJECT: "10715"
  FORTIFY_BUILD_ID: "agents-mulesoft"

  # Whitesource
  WS_PROJECT_ID: "agents-mulesoft"
  WS_CONFIG_FILE: "whitesource.config"
  WS_BRANCH: main

include:
  - project: "apigov/beano_cicd"
    ref: master
    # the order of these include files is important
    file:
      - "/gitlabci/csrjobs.yml"
  - project: 'scurity/gitlabci'
    ref: master
    file:
      - '/.gitlab-ci-prepcsr.yml'
      - '/.gitlab-ci-fortify.yml'
      - "/.gitlab-ci-twistlock.yml"
      - "/.gitlab-ci-whitesource.yml"
      - "/.gitlab-ci-csr.yml"

.get-latest-tag: &get-latest-tag |
  if [ $(git --version | grep -Eo '2.*') ]; then 
    export IMAGE_TAG=$(git tag -l --sort="version:refname" | grep -Eo '[0-9]{1,}\.[0-9]{1,}\.[0-9]{1,3}$' | tail -1)
  else 
    export IMAGE_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
  fi

stages:
  # - build
  # - push
  - security-scans
  - security-review

####################
# CSR - overridden from csrjobs.yml to effectively not see this job ever
####################
.dummy:
  stage: security-scans
  only:
    refs:
      - xxxxx
  script:
    - ""

fetch-iriusrisk:
  extends: .dummy

twistlock:
  extends: .dummy

# twistlock:on-schedule:
#   extends: .dummy
twistlock-discovery:
  extends: .twistlock
  before_script:
    - apk --no-cache update && apk add make
    - make docker-build-disc 
    - export IMAGE_NAME=mulesoft_discovery_agent:latest
  except:
    refs:
      - schedules
      - tags

twistlock-traceability:
  extends: .twistlock
  before_script:
    - apk --no-cache update && apk add make
    - make docker-build-trace 
    - export IMAGE_NAME=mulesoft_traceability_agent:latest
  except:
    refs:
      - schedules
      - tags

twistlock-discovery:on-schedule:
  extends: .twistlock
  dependencies: []
  before_script:
    - apk --no-cache update && add git
    - *get-latest-tag
    - export IMAGE_NAME=mulesoft_discovery_agent:${LAST_TAG}
  only:
    refs:
      - schedules

twistlock-traceability:on-schedule:
  extends: .twistlock
  dependencies: []
  before_script:
    - apk --no-cache update && add git
    - *get-latest-tag
    - export IMAGE_NAME=mulesoft_discovery_agent:${LAST_TAG}
  only:
    refs:
      - schedules

twistlock-master:
  extends: .dummy

run-csr:
  dependencies:
    - fetch-fortify
    - twistlock-discovery
    - twistlock-traceability
    - whitesource

# run-csr-traceability:
#   dependencies:
#     - fetch-fortify
#     - twistlock-traceability
#     - whitesource

update-csr:
  dependencies:
    - fetch-fortify
    - twistlock-discovery:on-schedule
    - twistlock-traceability:on-schedule
    - whitesource:on-schedule

# update-csr-trace:
#   dependencies:
#     - fetch-fortify
#     - twistlock:on-schedule
#     - whitesource:on-schedule
